# ğŸ”§ æƒé™è‡ªåŠ¨è·³è½¬è®¾ç½®é—®é¢˜ä¿®å¤

## é—®é¢˜æè¿°

**ç—‡çŠ¶**: ç‚¹å‡»è¯­éŸ³æŒ‰é’®åï¼Œåº”ç”¨è‡ªåŠ¨è·³è½¬åˆ°ç³»ç»Ÿè®¾ç½®é¡µé¢ï¼Œè€Œä¸æ˜¯å…ˆå¼¹å‡ºæƒé™è¯·æ±‚å¯¹è¯æ¡†ã€‚

## æ ¹æœ¬åŸå› 

1. **æƒé™ä¹‹å‰è¢«æ‹’ç»è¿‡** - Android è®°ä½äº†"ä¸å†è¯¢é—®"çš„çŠ¶æ€
2. **Alert å¯¹è¯æ¡†å¯èƒ½è¢«è¯¯è§¦** - "å»è®¾ç½®"æŒ‰é’®è¢«ç«‹å³è§¦å‘
3. **æ²¡æœ‰ç»™ç”¨æˆ·é€‰æ‹©çš„æœºä¼š** - ç›´æ¥è·³è½¬è€Œä¸æ˜¯è®©ç”¨æˆ·ç¡®è®¤

## è§£å†³æ–¹æ¡ˆ

### 1. æ¸…é™¤ä¹‹å‰çš„æƒé™çŠ¶æ€

**æ–¹æ³• 1: å¸è½½é‡è£…ï¼ˆæ¨èï¼‰**
```bash
# ä½¿ç”¨è„šæœ¬è‡ªåŠ¨å¸è½½é‡è£…
./scripts/reinstall-apk.sh

# æˆ–æ‰‹åŠ¨æ“ä½œ
adb uninstall com.tiyuchong.nekorn
adb install android/app/build/outputs/apk/debug/app-debug.apk
```

**æ–¹æ³• 2: æ‰‹åŠ¨æ¸…é™¤åº”ç”¨æ•°æ®**
```
è®¾ç½® â†’ åº”ç”¨ â†’ N.E.K.O. â†’ å­˜å‚¨ â†’ æ¸…é™¤æ•°æ®
```

### 2. ä»£ç å±‚é¢çš„ä¿®å¤

**æ–‡ä»¶**: `utils/permissions.js`

**æ”¹è¿›å†…å®¹**:

1. âœ… **å»¶è¿Ÿæ˜¾ç¤ºå¯¹è¯æ¡†** - é¿å…æƒé™å¯¹è¯æ¡†å’Œ Alert å†²çª
2. âœ… **æ›´æ¸…æ™°çš„æç¤º** - æ˜ç¡®å‘Šè¯‰ç”¨æˆ·ä¸ºä»€ä¹ˆéœ€è¦æƒé™
3. âœ… **ç”¨æˆ·å¯é€‰æ‹©** - "æš‚ä¸å¼€å¯" vs "å»è®¾ç½®"ï¼Œä¸ä¼šå¼ºåˆ¶è·³è½¬
4. âœ… **æ‹’ç»æ—¶ä¹Ÿæœ‰æç¤º** - å‘ŠçŸ¥ç”¨æˆ·åæœï¼Œä½†ä¸å¼ºåˆ¶è·³è½¬

**å…³é”®ä»£ç **:

```javascript
// NEVER_ASK_AGAIN çŠ¶æ€å¤„ç†
setTimeout(() => {
  Alert.alert(
    'éœ€è¦éº¦å…‹é£æƒé™',
    'æ‚¨ä¹‹å‰æ‹’ç»äº†éº¦å…‹é£æƒé™å¹¶é€‰æ‹©äº†"ä¸å†è¯¢é—®"ã€‚\n\nè¯­éŸ³åŠŸèƒ½éœ€è¦éº¦å…‹é£æƒé™æ‰èƒ½å·¥ä½œã€‚æ˜¯å¦å‰å¾€è®¾ç½®å¼€å¯æƒé™ï¼Ÿ',
    [
      {
        text: 'æš‚ä¸å¼€å¯',
        style: 'cancel',
        onPress: () => console.log('ç”¨æˆ·é€‰æ‹©ä¸å»è®¾ç½®'),
      },
      {
        text: 'å»è®¾ç½®',
        style: 'default',
        onPress: () => {
          Linking.openSettings();
        },
      },
    ],
    { cancelable: true }
  );
}, 500); // å»¶è¿Ÿ 500msï¼Œé¿å…ç«‹å³è·³è½¬
```

## æµ‹è¯•æµç¨‹

### åœºæ™¯ 1: é¦–æ¬¡è¯·æ±‚æƒé™ï¼ˆå¹²å‡€å®‰è£…ï¼‰

1. **å¸è½½æ—§ç‰ˆæœ¬**
   ```bash
   adb uninstall com.tiyuchong.nekorn
   ```

2. **å®‰è£…æ–°ç‰ˆæœ¬**
   ```bash
   adb install android/app/build/outputs/apk/debug/app-debug.apk
   ```

3. **æ‰“å¼€åº”ç”¨ï¼Œç‚¹å‡»è¯­éŸ³æŒ‰é’®**

4. **é¢„æœŸç»“æœ**:
   ```
   å¼¹å‡ºæƒé™å¯¹è¯æ¡†:
   - æ ‡é¢˜: "ğŸ¤ éœ€è¦éº¦å…‹é£æƒé™"
   - æ¶ˆæ¯: "N.E.K.O. éœ€è¦è®¿é—®æ‚¨çš„éº¦å…‹é£æ¥å®ç°è¯­éŸ³å¯¹è¯åŠŸèƒ½ã€‚"
   - æŒ‰é’®: "ç¡®å®š" / "å–æ¶ˆ" / "ç¨åè¯¢é—®"
   ```

5. **ç‚¹å‡»"ç¡®å®š"**
   ```
   âœ… æƒé™æˆäºˆ
   âœ… å¼€å§‹å½•éŸ³
   ```

### åœºæ™¯ 2: ç”¨æˆ·æ‹’ç»æƒé™

1. **ç‚¹å‡»è¯­éŸ³æŒ‰é’®**

2. **å¼¹å‡ºæƒé™å¯¹è¯æ¡†**

3. **ç‚¹å‡»"å–æ¶ˆ"**

4. **é¢„æœŸç»“æœ**:
   ```
   å»¶è¿Ÿ 300ms åæ˜¾ç¤ºæç¤º:
   - æ ‡é¢˜: "æƒé™è¢«æ‹’ç»"
   - æ¶ˆæ¯: "æ‚¨æ‹’ç»äº†éº¦å…‹é£æƒé™ï¼Œè¯­éŸ³åŠŸèƒ½å°†æ— æ³•ä½¿ç”¨ã€‚\n\næ‚¨å¯ä»¥ç¨ååœ¨è®¾ç½®ä¸­æ‰‹åŠ¨æˆäºˆæƒé™ã€‚"
   - æŒ‰é’®: "çŸ¥é“äº†"

   âœ… ä¸ä¼šè‡ªåŠ¨è·³è½¬è®¾ç½®
   âœ… ç”¨æˆ·å¯ä»¥ç»§ç»­ä½¿ç”¨æ–‡æœ¬åŠŸèƒ½
   ```

### åœºæ™¯ 3: ç”¨æˆ·é€‰æ‹©"ä¸å†è¯¢é—®"åå†æ¬¡å°è¯•

1. **æ‹’ç»æƒé™æ—¶å‹¾é€‰"ä¸å†è¯¢é—®"**

2. **å†æ¬¡ç‚¹å‡»è¯­éŸ³æŒ‰é’®**

3. **é¢„æœŸç»“æœ**:
   ```
   å»¶è¿Ÿ 500ms åæ˜¾ç¤ºæç¤º:
   - æ ‡é¢˜: "éœ€è¦éº¦å…‹é£æƒé™"
   - æ¶ˆæ¯: "æ‚¨ä¹‹å‰æ‹’ç»äº†éº¦å…‹é£æƒé™å¹¶é€‰æ‹©äº†"ä¸å†è¯¢é—®"ã€‚\n\nè¯­éŸ³åŠŸèƒ½éœ€è¦éº¦å…‹é£æƒé™æ‰èƒ½å·¥ä½œã€‚æ˜¯å¦å‰å¾€è®¾ç½®å¼€å¯æƒé™ï¼Ÿ"
   - æŒ‰é’®: "æš‚ä¸å¼€å¯" / "å»è®¾ç½®"

   âœ… ç”¨æˆ·å¯ä»¥é€‰æ‹©ä¸å»è®¾ç½®
   âœ… ç‚¹å‡»"å»è®¾ç½®"æ‰ä¼šè·³è½¬
   ```

## æ—¥å¿—è¾“å‡º

### æˆåŠŸåœºæ™¯
```bash
adb logcat | grep -E 'éº¦å…‹é£|PCMStream|æƒé™'
```

```
ğŸ” æ£€æŸ¥éº¦å…‹é£æƒé™...
âœ… éº¦å…‹é£æƒé™å·²æˆäºˆ
âœ… å½•éŸ³å·²å¯åŠ¨ (sampleRate=48000, targetRate=16000)
```

### æ‹’ç»åœºæ™¯
```
âŒ ç”¨æˆ·æ‹’ç»äº†éº¦å…‹é£æƒé™
# ç„¶åæ˜¾ç¤ºæç¤ºå¯¹è¯æ¡†
```

### NEVER_ASK_AGAIN åœºæ™¯
```
âŒ ç”¨æˆ·é€‰æ‹©"ä¸å†è¯¢é—®"
# å»¶è¿Ÿ 500ms åæ˜¾ç¤ºæç¤º
# ç”¨æˆ·ç‚¹å‡»"å»è®¾ç½®"æ‰ä¼šè·³è½¬
```

## å…³é”®æ”¹è¿›

### Before (æœ‰é—®é¢˜)
```javascript
// âŒ ç›´æ¥è·³è½¬ï¼Œç”¨æˆ·æ²¡æœ‰é€‰æ‹©æƒ
Alert.alert('éœ€è¦æƒé™', '...', [
  { text: 'å–æ¶ˆ' },
  { text: 'å»è®¾ç½®', onPress: () => Linking.openSettings() }
]);
return false;
```

### After (å·²ä¿®å¤)
```javascript
// âœ… å»¶è¿Ÿæ˜¾ç¤ºï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©
setTimeout(() => {
  Alert.alert('éœ€è¦éº¦å…‹é£æƒé™', '...\n\næ˜¯å¦å‰å¾€è®¾ç½®å¼€å¯æƒé™ï¼Ÿ', [
    { text: 'æš‚ä¸å¼€å¯', style: 'cancel' },
    { text: 'å»è®¾ç½®', onPress: () => Linking.openSettings() }
  ], { cancelable: true });
}, 500);
return false;
```

## é¢„é˜²æªæ–½

1. **æµ‹è¯•å‰å¸è½½æ—§ç‰ˆæœ¬** - ç¡®ä¿æ¸…é™¤ä¹‹å‰çš„æƒé™çŠ¶æ€
2. **ä½¿ç”¨è„šæœ¬å®‰è£…** - `./scripts/reinstall-apk.sh`
3. **æŸ¥çœ‹æ—¥å¿—ç¡®è®¤** - è§‚å¯Ÿæƒé™è¯·æ±‚æµç¨‹
4. **ä¸è¦è¿ç»­ç‚¹å‡»** - ç»™ç³»ç»Ÿæ—¶é—´å¤„ç†æƒé™è¯·æ±‚

## ç›¸å…³æ–‡ä»¶

- `utils/permissions.js` - æƒé™è¯·æ±‚é€»è¾‘ï¼ˆå·²ä¿®å¤ï¼‰
- `services/AudioService.ts` - åœ¨ startRecording() ä¸­è°ƒç”¨æƒé™è¯·æ±‚
- `scripts/reinstall-apk.sh` - å¸è½½é‡è£…è„šæœ¬

## å¦‚æœé—®é¢˜ä¾ç„¶å­˜åœ¨

1. **å®Œå…¨æ¸…é™¤åº”ç”¨æ•°æ®**
   ```bash
   adb shell pm clear com.tiyuchong.nekorn
   ```

2. **æ£€æŸ¥æ—¥å¿—**
   ```bash
   adb logcat -c
   adb logcat | grep -E 'Permission|RECORD_AUDIO|éº¦å…‹é£'
   ```

3. **æ‰‹åŠ¨æˆäºˆæƒé™**
   ```bash
   adb shell pm grant com.tiyuchong.nekorn android.permission.RECORD_AUDIO
   ```

4. **æ£€æŸ¥è®¾å¤‡è®¾ç½®**
   ```
   è®¾ç½® â†’ åº”ç”¨ â†’ N.E.K.O. â†’ æƒé™ â†’ éº¦å…‹é£
   ```
